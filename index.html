<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC as a Service - Connect with Local CNC Workshops</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-primary">CNC Service</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userEmail" class="text-gray-600"></span>
                    <button id="signOutBtn" class="hidden px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Authentication Section -->
        <div id="authSection" class="bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-6">Welcome to CNC as a Service</h2>
            <p class="text-gray-600 mb-8">Sign in to access your dashboard and start your CNC projects</p>
            
            <!-- Sign In Form -->
            <div id="signInForm" class="space-y-4">
                <h3 class="text-xl font-semibold">Sign In</h3>
                <input type="email" id="signInEmail" placeholder="Email" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                <input type="password" id="signInPassword" placeholder="Password" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                <button id="signInSubmit" 
                    class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition">
                    Sign In
                </button>
                <p class="text-center text-gray-600">
                    Don't have an account? 
                    <button id="showSignUp" class="text-primary hover:underline">Sign Up</button>
                </p>
            </div>
            
            <!-- Sign Up Form -->
            <div id="signUpForm" class="space-y-4 hidden">
                <h3 class="text-xl font-semibold">Create Account</h3>
                <input type="text" id="signUpName" placeholder="Full Name" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                <input type="email" id="signUpEmail" placeholder="Email" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                <input type="password" id="signUpPassword" placeholder="Password" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                <button id="signUpSubmit" 
                    class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition">
                    Sign Up
                </button>
                <p class="text-center text-gray-600">
                    Already have an account? 
                    <button id="showSignIn" class="text-primary hover:underline">Sign In</button>
                </p>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden space-y-8">
            
            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button data-tab="newProject" class="tab-btn py-4 px-1 border-b-2 border-primary font-medium text-primary">
                            New Project
                        </button>
                        <button data-tab="myOrders" class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-gray-600 hover:text-gray-800">
                            My Orders
                        </button>
                        <button data-tab="workshops" class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-gray-600 hover:text-gray-800">
                            Workshops
                        </button>
                    </nav>
                </div>
            </div>

            <!-- New Project Tab -->
            <div id="newProjectTab" class="tab-content bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-6">Start a New CNC Project</h2>
                
                <!-- File Upload Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">1. Upload Design File</h3>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <input type="file" id="fileInput" accept=".dxf,.stl,.step,.stp" class="hidden">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <button id="uploadBtn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition">
                            Choose File
                        </button>
                        <p class="mt-2 text-sm text-gray-600">Accepted formats: .dxf, .stl, .step</p>
                        <p id="fileName" class="mt-4 text-sm font-medium text-gray-900"></p>
                    </div>
                </div>

                <!-- Project Specifications -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">2. Project Specifications</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Material Type</label>
                            <select id="material" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Select Material</option>
                                <option value="aluminum">Aluminum</option>
                                <option value="steel">Steel</option>
                                <option value="brass">Brass</option>
                                <option value="plastic">Plastic</option>
                                <option value="wood">Wood</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                            <input type="number" id="quantity" min="1" value="1" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tolerance (mm)</label>
                            <input type="number" id="tolerance" step="0.01" placeholder="0.1" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Finish Type</label>
                            <select id="finish" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="none">None</option>
                                <option value="polished">Polished</option>
                                <option value="anodized">Anodized</option>
                                <option value="painted">Painted</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                        <textarea id="notes" rows="3" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="Any special requirements or instructions..."></textarea>
                    </div>
                </div>

                <!-- Location Input -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">3. Your Location</h3>
                    <div class="flex gap-4">
                        <input type="text" id="location" placeholder="Enter your city or zip code" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <button id="detectLocation" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                            Detect Location
                        </button>
                    </div>
                </div>

                <button id="findWorkshops" class="w-full px-6 py-3 bg-primary text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                    Find Available Workshops
                </button>
            </div>

            <!-- Workshop Selection -->
            <div id="workshopSelection" class="hidden bg-white p-8 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-6">Available Workshops</h3>
                <div id="workshopList" class="space-y-4">
                    <!-- Workshop items will be dynamically added here -->
                </div>
            </div>

            <!-- Booking Calendar -->
            <div id="bookingCalendar" class="hidden bg-white p-8 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-6">Select Time Slot</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Date</label>
                    <input type="date" id="bookingDate" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div class="grid grid-cols-3 md:grid-cols-4 gap-2 mb-6" id="timeSlots">
                    <!-- Time slots will be dynamically added here -->
                </div>
                <button id="confirmBooking" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                    Confirm Booking
                </button>
            </div>

            <!-- My Orders Tab -->
            <div id="myOrdersTab" class="tab-content hidden bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-6">My Orders</h2>
                <div id="ordersList" class="space-y-4">
                    <!-- Orders will be dynamically added here -->
                </div>
            </div>

            <!-- Workshops Tab -->
            <div id="workshopsTab" class="tab-content hidden bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-6">All Workshops</h2>
                <div id="allWorkshopsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- All workshops will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
            <p class="mt-4 text-gray-600">Processing...</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg max-w-md mx-auto">
            <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <h3 class="text-xl font-bold text-center mb-2">Booking Confirmed!</h3>
            <p class="text-gray-600 text-center mb-4">Your order has been successfully placed.</p>
            <p class="text-center font-semibold">Order ID: <span id="orderIdDisplay"></span></p>
            <button id="closeModal" class="mt-6 w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition">
                View My Orders
            </button>
        </div>
    </div>

    <script>
        // Mock Firebase for Demo - Replace this section with real Firebase config for production
        const USE_MOCK_AUTH = true; // Set to false when using real Firebase
        
        // Firebase Configuration - Replace with your own config for production
        const firebaseConfig = {
            apiKey: "AIzaSyD-REPLACE-WITH-YOUR-KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Mock Firebase Auth Implementation
        const mockAuth = {
            currentUser: null,
            authStateCallbacks: [],
            
            onAuthStateChanged(callback) {
                this.authStateCallbacks.push(callback);
                // Check if user is stored in session
                const storedUser = localStorage.getItem('mockCurrentUser');
                if (storedUser) {
                    this.currentUser = JSON.parse(storedUser);
                }
                callback(this.currentUser);
            },
            
            createUserWithEmailAndPassword(email, password) {
                return new Promise((resolve, reject) => {
                    // Check if user already exists
                    const users = JSON.parse(localStorage.getItem('mockUsers') || '[]');
                    if (users.find(u => u.email === email)) {
                        reject({ message: 'Email already in use' });
                        return;
                    }
                    
                    // Create new user
                    const newUser = {
                        uid: 'user_' + Date.now(),
                        email: email,
                        displayName: '',
                        updateProfile: function(profile) {
                            this.displayName = profile.displayName || this.displayName;
                            localStorage.setItem('mockCurrentUser', JSON.stringify(this));
                            return Promise.resolve();
                        }
                    };
                    
                    // Save user
                    users.push({ email, password, uid: newUser.uid });
                    localStorage.setItem('mockUsers', JSON.stringify(users));
                    
                    this.currentUser = newUser;
                    localStorage.setItem('mockCurrentUser', JSON.stringify(newUser));
                    
                    // Notify listeners
                    this.authStateCallbacks.forEach(cb => cb(newUser));
                    
                    resolve({ user: newUser });
                });
            },
            
            signInWithEmailAndPassword(email, password) {
                return new Promise((resolve, reject) => {
                    const users = JSON.parse(localStorage.getItem('mockUsers') || '[]');
                    const user = users.find(u => u.email === email && u.password === password);
                    
                    if (!user) {
                        reject({ message: 'Invalid email or password' });
                        return;
                    }
                    
                    const userObj = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || ''
                    };
                    
                    this.currentUser = userObj;
                    localStorage.setItem('mockCurrentUser', JSON.stringify(userObj));
                    
                    // Notify listeners
                    this.authStateCallbacks.forEach(cb => cb(userObj));
                    
                    resolve({ user: userObj });
                });
            },
            
            signOut() {
                this.currentUser = null;
                localStorage.removeItem('mockCurrentUser');
                this.authStateCallbacks.forEach(cb => cb(null));
                return Promise.resolve();
            }
        };
        
        // Mock Firestore Implementation
        const mockDb = {
            collection(name) {
                return {
                    doc(id) {
                        return {
                            set(data) {
                                const collections = JSON.parse(localStorage.getItem('mockCollections') || '{}');
                                if (!collections[name]) collections[name] = {};
                                collections[name][id] = { ...data, id };
                                localStorage.setItem('mockCollections', JSON.stringify(collections));
                                return Promise.resolve();
                            },
                            get() {
                                const collections = JSON.parse(localStorage.getItem('mockCollections') || '{}');
                                const doc = collections[name] && collections[name][id];
                                return Promise.resolve({
                                    exists: !!doc,
                                    data: () => doc
                                });
                            }
                        };
                    }
                };
            }
        };
        
        // Mock Firebase namespace
        const mockFirebase = {
            firestore: {
                FieldValue: {
                    serverTimestamp: () => new Date().toISOString()
                }
            }
        };

        // Initialize Firebase or Mock based on configuration
        let auth, db, storage;
        
        if (USE_MOCK_AUTH) {
            console.log('Using mock authentication for demo');
            auth = mockAuth;
            db = mockDb;
            storage = {}; // Mock storage if needed
            window.firebase = mockFirebase;
        } else {
            // Initialize real Firebase
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
        }

        // Global Variables
        let currentUser = null;
        let selectedFile = null;
        let selectedWorkshop = null;
        let selectedTimeSlot = null;
        let currentProjectData = {};

        // Mock workshop data (in production, this would come from Firestore)
        const mockWorkshops = [
            {
                id: 'ws1',
                name: 'Precision CNC Works',
                distance: 2.5,
                capabilities: ['3-axis', '5-axis', 'Large format'],
                materials: ['Aluminum', 'Steel', 'Brass'],
                rating: 4.8,
                turnaround: '3-5 days'
            },
            {
                id: 'ws2',
                name: 'Metro Machine Shop',
                distance: 4.1,
                capabilities: ['3-axis', 'Laser cutting'],
                materials: ['Aluminum', 'Plastic', 'Wood'],
                rating: 4.5,
                turnaround: '2-4 days'
            },
            {
                id: 'ws3',
                name: 'Advanced Manufacturing Co',
                distance: 7.8,
                capabilities: ['5-axis', 'EDM', 'Surface grinding'],
                materials: ['All metals', 'Composites'],
                rating: 4.9,
                turnaround: '5-7 days'
            }
        ];

        // Authentication State Observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('signOutBtn').classList.remove('hidden');
                loadUserOrders();
            } else {
                currentUser = null;
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
                document.getElementById('userEmail').textContent = '';
                document.getElementById('signOutBtn').classList.add('hidden');
            }
        });

        // Sign Up
        document.getElementById('signUpSubmit').addEventListener('click', async () => {
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const name = document.getElementById('signUpName').value;

            if (!email || !password || !name) {
                alert('Please fill in all fields');
                return;
            }

            try {
                showLoading();
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Save user profile to Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await userCredential.user.updateProfile({
                    displayName: name
                });

                hideLoading();
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });

        // Sign In
        document.getElementById('signInSubmit').addEventListener('click', async () => {
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            try {
                showLoading();
                await auth.signInWithEmailAndPassword(email, password);
                hideLoading();
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });

        // Sign Out
        document.getElementById('signOutBtn').addEventListener('click', () => {
            auth.signOut();
        });

        // Toggle between Sign In and Sign Up forms
        document.getElementById('showSignUp').addEventListener('click', () => {
            document.getElementById('signInForm').classList.add('hidden');
            document.getElementById('signUpForm').classList.remove('hidden');
        });

        document.getElementById('showSignIn').addEventListener('click', () => {
            document.getElementById('signInForm').classList.remove('hidden');
            document.getElementById('signUpForm').classList.add('hidden');
        });

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                
                // Update active tab styling
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('border-primary', 'text-primary');
                    btn.classList.add('border-transparent', 'text-gray-600');
                });
                e.target.classList.remove('border-transparent', 'text-gray-600');
                e.target.classList.add('border-primary', 'text-primary');
                
                // Show corresponding tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabName}Tab`).classList.remove('hidden');
                
                // Hide workshop selection and booking calendar when switching tabs
                document.getElementById('workshopSelection').classList.add('hidden');
                document.getElementById('bookingCalendar').classList.add('hidden');
                
                // Load content based on tab
                if (tabName === 'myOrders') {
                    loadUserOrders();
                } else if (tabName === 'workshops') {
                    loadAllWorkshops();
                }
            });
        });

        // File Upload
        document.getElementById('uploadBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = `Selected: ${file.name}`;
            }
        });

        // Detect Location
        document.getElementById('detectLocation').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // In a real app, you'd convert coordinates to address
                        document.getElementById('location').value = 'Current Location';
                    },
                    (error) => {
                        alert('Unable to detect location. Please enter manually.');
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        });

        // Find Workshops
        document.getElementById('findWorkshops').addEventListener('click', () => {
            const material = document.getElementById('material').value;
            const quantity = document.getElementById('quantity').value;
            const tolerance = document.getElementById('tolerance').value;
            const finish = document.getElementById('finish').value;
            const notes = document.getElementById('notes').value;
            const location = document.getElementById('location').value;

            if (!selectedFile) {
                alert('Please upload a design file');
                return;
            }

            if (!material || !quantity || !tolerance || !location) {
                alert('Please fill in all required fields');
                return;
            }

            // Store project data
            currentProjectData = {
                material,
                quantity,
                tolerance,
                finish,
                notes,
                location,
                fileName: selectedFile.name
            };

            // Show workshop list
            displayWorkshops();
        });

        // Display Workshops
        function displayWorkshops() {
            const workshopList = document.getElementById('workshopList');
            workshopList.innerHTML = '';

            mockWorkshops.forEach(workshop => {
                const workshopCard = document.createElement('div');
                workshopCard.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-lg transition cursor-pointer';
                workshopCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-lg font-semibold">${workshop.name}</h4>
                        <span class="text-sm text-gray-500">${workshop.distance} km away</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <span class="text-sm">${workshop.rating}</span>
                        <span class="text-sm text-gray-500 ml-4">Turnaround: ${workshop.turnaround}</span>
                    </div>
                    <div class="mb-2">
                        <span class="text-sm text-gray-600">Capabilities: </span>
                        <span class="text-sm">${workshop.capabilities.join(', ')}</span>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">Materials: </span>
                        <span class="text-sm">${workshop.materials.join(', ')}</span>
                    </div>
                    <button onclick="selectWorkshop('${workshop.id}')" 
                        class="mt-4 w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition">
                        Select Workshop
                    </button>
                `;
                workshopList.appendChild(workshopCard);
            });

            document.getElementById('workshopSelection').classList.remove('hidden');
        }

        // Select Workshop
        function selectWorkshop(workshopId) {
            selectedWorkshop = mockWorkshops.find(w => w.id === workshopId);
            document.getElementById('bookingCalendar').classList.remove('hidden');
            generateTimeSlots();
        }

        // Generate Time Slots
        function generateTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '';
            
            const times = ['9:00 AM', '10:00 AM', '11:00 AM', '12:00 PM', 
                          '2:00 PM', '3:00 PM', '4:00 PM', '5:00 PM'];
            
            times.forEach(time => {
                const slot = document.createElement('button');
                slot.className = 'px-3 py-2 border border-gray-300 rounded-lg hover:bg-primary hover:text-white transition';
                slot.textContent = time;
                slot.onclick = () => {
                    // Clear previous selection
                    document.querySelectorAll('#timeSlots button').forEach(btn => {
                        btn.classList.remove('bg-primary', 'text-white');
                    });
                    // Select current slot
                    slot.classList.add('bg-primary', 'text-white');
                    selectedTimeSlot = time;
                };
                timeSlotsContainer.appendChild(slot);
            });
        }

        // Confirm Booking
        document.getElementById('confirmBooking').addEventListener('click', async () => {
            const bookingDate = document.getElementById('bookingDate').value;
            
            if (!bookingDate || !selectedTimeSlot) {
                alert('Please select a date and time slot');
                return;
            }

            try {
                showLoading();
                
                // Generate order ID
                const orderId = 'CNC' + Date.now();
                
                // Upload file to Firebase Storage (in production)
                // For now, we'll simulate this
                
                // Create order in Firestore
                const orderData = {
                    orderId: orderId,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    workshop: {
                        id: selectedWorkshop.id,
                        name: selectedWorkshop.name
                    },
                    projectDetails: currentProjectData,
                    booking: {
                        date: bookingDate,
                        timeSlot: selectedTimeSlot
                    },
                    status: 'Awaiting Confirmation',
                    createdAt: new Date().toISOString(),
                    trackingNumber: null
                };

                // In production, save to Firestore
                // await db.collection('orders').doc(orderId).set(orderData);
                
                // For demo, save to localStorage
                const orders = JSON.parse(localStorage.getItem('cncOrders') || '[]');
                orders.push(orderData);
                localStorage.setItem('cncOrders', JSON.stringify(orders));
                
                hideLoading();
                
                // Show success modal
                document.getElementById('orderIdDisplay').textContent = orderId;
                document.getElementById('successModal').classList.remove('hidden');
                
                // Reset form
                resetNewProjectForm();
                
            } catch (error) {
                hideLoading();
                alert('Error creating order: ' + error.message);
            }
        });

        // Close Success Modal
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('successModal').classList.add('hidden');
            // Switch to My Orders tab
            document.querySelector('[data-tab="myOrders"]').click();
        });

        // Load User Orders
        function loadUserOrders() {
            if (!currentUser) return;
            
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '';
            
            // Load from localStorage for demo
            const orders = JSON.parse(localStorage.getItem('cncOrders') || '[]');
            const userOrders = orders.filter(order => order.userEmail === currentUser.email);
            
            if (userOrders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500 text-center py-8">No orders found</p>';
                return;
            }
            
            userOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'border border-gray-200 rounded-lg p-6';
                
                const statusColor = getStatusColor(order.status);
                
                orderCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold">Order #${order.orderId}</h4>
                            <p class="text-sm text-gray-500">Created: ${new Date(order.createdAt).toLocaleDateString()}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                            ${order.status}
                        </span>
                    </div>
                    <div class="space-y-2">
                        <p class="text-sm"><span class="font-medium">Workshop:</span> ${order.workshop.name}</p>
                        <p class="text-sm"><span class="font-medium">Material:</span> ${order.projectDetails.material}</p>
                        <p class="text-sm"><span class="font-medium">Quantity:</span> ${order.projectDetails.quantity}</p>
                        <p class="text-sm"><span class="font-medium">Booking:</span> ${order.booking.date} at ${order.booking.timeSlot}</p>
                        ${order.trackingNumber ? `
                            <p class="text-sm"><span class="font-medium">Tracking:</span> 
                                <span class="text-primary">${order.trackingNumber}</span>
                            </p>
                        ` : ''}
                    </div>
                    ${order.status === 'Awaiting Confirmation' ? `
                        <button onclick="simulateStatusUpdate('${order.orderId}')" 
                            class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                            Simulate Status Update
                        </button>
                    ` : ''}
                `;
                
                ordersList.appendChild(orderCard);
            });
        }

        // Load All Workshops
        function loadAllWorkshops() {
            const allWorkshopsList = document.getElementById('allWorkshopsList');
            allWorkshopsList.innerHTML = '';
            
            mockWorkshops.forEach(workshop => {
                const workshopCard = document.createElement('div');
                workshopCard.className = 'border border-gray-200 rounded-lg p-6';
                workshopCard.innerHTML = `
                    <h4 class="text-lg font-semibold mb-2">${workshop.name}</h4>
                    <div class="flex items-center mb-2">
                        <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <span class="text-sm">${workshop.rating} Rating</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">Turnaround: ${workshop.turnaround}</p>
                    <p class="text-sm text-gray-600 mb-1">Capabilities: ${workshop.capabilities.join(', ')}</p>
                    <p class="text-sm text-gray-600">Materials: ${workshop.materials.join(', ')}</p>
                `;
                allWorkshopsList.appendChild(workshopCard);
            });
        }

        // Get Status Color
        function getStatusColor(status) {
            switch(status) {
                case 'Awaiting Confirmation':
                    return 'bg-yellow-100 text-yellow-800';
                case 'In Progress':
                    return 'bg-blue-100 text-blue-800';
                case 'Completed':
                    return 'bg-purple-100 text-purple-800';
                case 'Shipped':
                    return 'bg-green-100 text-green-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Simulate Status Update (for demo purposes)
        function simulateStatusUpdate(orderId) {
            const orders = JSON.parse(localStorage.getItem('cncOrders') || '[]');
            const orderIndex = orders.findIndex(o => o.orderId === orderId);
            
            if (orderIndex !== -1) {
                const statuses = ['In Progress', 'Completed', 'Shipped'];
                const currentStatusIndex = statuses.indexOf(orders[orderIndex].status);
                const nextStatus = currentStatusIndex === -1 ? 'In Progress' : 
                                  currentStatusIndex < statuses.length - 1 ? statuses[currentStatusIndex + 1] : 
                                  statuses[statuses.length - 1];
                
                orders[orderIndex].status = nextStatus;
                
                if (nextStatus === 'Shipped') {
                    orders[orderIndex].trackingNumber = 'TRK' + Math.random().toString(36).substr(2, 9).toUpperCase();
                }
                
                localStorage.setItem('cncOrders', JSON.stringify(orders));
                loadUserOrders();
            }
        }

        // Reset New Project Form
        function resetNewProjectForm() {
            selectedFile = null;
            selectedWorkshop = null;
            selectedTimeSlot = null;
            currentProjectData = {};
            
            document.getElementById('fileInput').value = '';
            document.getElementById('fileName').textContent = '';
            document.getElementById('material').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('tolerance').value = '';
            document.getElementById('finish').value = 'none';
            document.getElementById('notes').value = '';
            document.getElementById('location').value = '';
            document.getElementById('bookingDate').value = '';
            
            document.getElementById('workshopSelection').classList.add('hidden');
            document.getElementById('bookingCalendar').classList.add('hidden');
        }

        // Loading Functions
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        // Set minimum date for booking to today
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bookingDate').setAttribute('min', today);
        });
    </script>
</body>
</html>
